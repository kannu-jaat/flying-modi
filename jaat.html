<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§ï‡§µ‡§ø‡§§‡§æ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f4f4f4; flex-direction: column; }
        #container { display: flex; width: 80%; max-width: 1200px; background-color: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #video-panel { flex: 1; min-width: 300px; background: black; position: relative; }
        #video-preview { width: 100%; height: auto; display: block; transform: scaleX(-1); /* Selfie view */ }
        #poem-panel { flex: 1; padding: 20px; overflow-y: auto; }
        #status { margin-top: 10px; font-weight: bold; color: green; }
        #poem-text { white-space: pre-wrap; font-size: 1.1em; line-height: 1.6; }
        .recording-indicator { position: absolute; top: 10px; left: 10px; color: red; font-size: 20px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <h1>‡§ï‡§µ‡§ø‡§§‡§æ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó</h1>

    <div id="container">
        <div id="video-panel">
            <video id="video-preview" autoplay muted playsinline></video>
            <div id="recording-status" class="recording-indicator" style="display: none;">üî¥ REC</div>
        </div>

        <div id="poem-panel">
            <h2>‡§Ü‡§ú ‡§ï‡•Ä ‡§ï‡§µ‡§ø‡§§‡§æ</h2>
            <div id="status">‡§ï‡•à‡§Æ‡§∞‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
            <pre id="poem-text">
                ‡§µ‡§π ‡§§‡•ã‡§°‡§º‡§§‡•Ä ‡§™‡§§‡•ç‡§•‡§∞
                ‡§¶‡•á‡§ñ‡§æ ‡§â‡§∏‡•á ‡§Æ‡•à‡§Ç‡§®‡•á ‡§á‡§≤‡§æ‡§π‡§æ‡§¨‡§æ‡§¶ ‡§ï‡•á ‡§™‡§• ‡§™‡§∞
                ‡§µ‡§π ‡§§‡•ã‡§°‡§º‡§§‡•Ä ‡§™‡§§‡•ç‡§•‡§∞‡•§
                ‡§ï‡•ã‡§à ‡§® ‡§õ‡§æ‡§Ø‡§æ‡§¶‡§æ‡§∞
                ‡§™‡•á‡§°‡§º ‡§µ‡§π ‡§ú‡§ø‡§∏‡§ï‡•á ‡§§‡§≤‡•á ‡§¨‡•à‡§†‡•Ä ‡§π‡•Å‡§à ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞‡•§
                ‡§∂‡•ç‡§Ø‡§æ‡§Æ ‡§§‡§®, ‡§≠‡§∞ ‡§¨‡§Å‡§ß‡§æ ‡§Ø‡•å‡§µ‡§®,
                ‡§®‡§§ ‡§®‡§Ø‡§®, ‡§™‡•ç‡§∞‡§ø‡§Ø-‡§ï‡§∞‡•ç‡§Æ-‡§∞‡§§ ‡§Æ‡§®,
                ‡§ó‡•Å‡§∞‡•Å ‡§π‡§•‡•å‡§°‡§º‡§æ ‡§π‡§æ‡§•,
                ‡§ï‡§∞‡§§‡•Ä ‡§¨‡§æ‡§∞-‡§¨‡§æ‡§∞ ‡§™‡•ç‡§∞‡§π‡§æ‡§∞:
                ‡§∏‡§æ‡§Æ‡§®‡•á ‡§§‡§∞‡•Å-‡§Æ‡§æ‡§≤‡§ø‡§ï‡§æ ‡§Ö‡§ü‡•ç‡§ü‡§æ‡§≤‡§ø‡§ï‡§æ, ‡§™‡•ç‡§∞‡§æ‡§ï‡§æ‡§∞‡•§
                ‚Äî ‡§∏‡•Ç‡§∞‡•ç‡§Ø‡§ï‡§æ‡§Ç‡§§ ‡§§‡•ç‡§∞‡§ø‡§™‡§æ‡§†‡•Ä '‡§®‡§ø‡§∞‡§æ‡§≤‡§æ'
            </pre>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // üö® ‡§á‡§∏‡•á ‡§Ö‡§™‡§®‡•á Deno Deploy URL ‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç
        const UPLOAD_URL = 'https://video.kannu-jaat.deno.net/'; 
        const CHUNK_SIZE_MS = 5000; // 5 ‡§∏‡•á‡§ï‡§Ç‡§°

        // --- DOM Elements ---
        const videoElement = document.getElementById('video-preview');
        const statusElement = document.getElementById('status');
        const recordingStatusElement = document.getElementById('recording-status');
        
        // --- Recording Variables ---
        let mediaRecorder;
        let stream;
        let chunkIndex = 0; // ‡§ö‡§Ç‡§ï ‡§ï‡•ã ‡§ï‡•ç‡§∞‡§Æ ‡§¶‡•á‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
        
        // --- UPLOAD FUNCTION ---
        
        /**
         * ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ö‡§Ç‡§ï ‡§ï‡•ã Deno Deploy ‡§¨‡•à‡§ï‡§è‡§Ç‡§° ‡§™‡§∞ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
         * @param {Blob} chunk - ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§°‡•á‡§ü‡§æ
         */
        async function uploadVideoChunk(chunk) {
            if (chunk.size === 0) return; // ‡§ñ‡§æ‡§≤‡•Ä ‡§ö‡§Ç‡§ï ‡§Ö‡§™‡§≤‡•ã‡§° ‡§® ‡§ï‡§∞‡•á‡§Ç

            const formData = new FormData();
            // üö® Deno Deploy ‡§ï‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§π‡§Æ‡§®‡•á ‡§á‡§∏‡•á 'video_chunk' ‡§®‡§æ‡§Æ ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§•‡§æ
            formData.append('video_chunk', chunk, `chunk_${chunkIndex++}.webm`); 
            
            try {
                const response = await fetch(UPLOAD_URL, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    console.log(`Chunk ${chunkIndex - 1} uploaded successfully!`);
                } else {
                    console.error(`Chunk upload failed: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Network or server error during upload:', error);
            }
        }

        // --- INITIALIZATION AND RECORDING LOGIC ---

        /**
         * ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
         */
        async function startRecording() {
            statusElement.textContent = '‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';
            
            try {
                // ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§î‡§∞ ‡§Æ‡§æ‡§á‡§ï‡•ç‡§∞‡•ã‡§´‡§º‡•ã‡§® ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Æ‡§æ‡§Ç‡§ó‡§®‡§æ
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' }, // ‡§´‡•ç‡§∞‡§Ç‡§ü ‡§ï‡•à‡§Æ‡§∞‡§æ
                    audio: true 
                });
                
                // ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§™‡•ç‡§∞‡•Ä‡§µ‡•ç‡§Ø‡•Ç ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ
                videoElement.srcObject = stream;
                statusElement.textContent = '‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§µ‡§ø‡§§‡§æ ‡§™‡§¢‡§º‡•á‡§Ç!';
                recordingStatusElement.style.display = 'block';

                // MediaRecorder ‡§ï‡•ã ‡§∏‡•á‡§ü ‡§ï‡§∞‡§®‡§æ
                // ‡§π‡§Æ 'video/webm; codecs=vp8,opus' ‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§ü ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á ‡§ú‡•ã ‡§µ‡•á‡§¨ ‡§™‡§∞ ‡§µ‡•ç‡§Ø‡§æ‡§™‡§ï ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§π‡•à
                const options = { mimeType: 'video/webm; codecs=vp8' };
                mediaRecorder = new MediaRecorder(stream, options);

                // ‡§ú‡§¨ ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•ã (CHUNK_SIZE_MS ‡§ï‡•á ‡§Ö‡§Ç‡§§‡§∞‡§æ‡§≤ ‡§™‡§∞)
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        // ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ö‡§Ç‡§ï ‡§ï‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                        uploadVideoChunk(event.data);
                    }
                };

                // ‡§π‡§∞ 5 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç ‡§®‡§Ø‡§æ ‡§°‡•á‡§ü‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
                mediaRecorder.start(CHUNK_SIZE_MS); 
                
            } catch (err) {
                // ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§π‡•ã‡§®‡•á ‡§Ø‡§æ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§® ‡§Æ‡§ø‡§≤‡§®‡•á ‡§™‡§∞
                statusElement.textContent = '‚ùå ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§Ç ‡§î‡§∞ ‡§™‡•á‡§ú ‡§∞‡•Ä‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§';
                console.error('Error accessing media devices:', err);
            }
        }

        /**
         * ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§∞‡§ø‡§≤‡•Ä‡§ú‡§º ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
         */
        function stopRecordingAndCleanup() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                recordingStatusElement.style.display = 'none';
                statusElement.textContent = '‚úÖ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§¨‡§Ç‡§¶ ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡•§ ‡§Ö‡§™‡§≤‡•ã‡§°‡§ø‡§Ç‡§ó ‡§™‡•Ç‡§∞‡•Ä ‡§π‡•ã‡§®‡•á ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç...';
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            console.log("Cleanup done. Tracks stopped.");
        }

        // --- Event Listeners ---
        
        // ‡§™‡•á‡§ú ‡§≤‡•ã‡§° ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
        window.addEventListener('load', startRecording);

        // ‡§ú‡§¨ ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ü‡•à‡§¨ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á ‡§Ø‡§æ ‡§™‡•á‡§ú ‡§õ‡•ã‡§°‡§º‡•á, ‡§§‡•ã ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
        window.addEventListener('beforeunload', stopRecordingAndCleanup);
        window.addEventListener('pagehide', stopRecordingAndCleanup);
        
    </script>
</body>
</html>
